<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ¼ãƒ‰é¸æŠ - ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="/css/common.css">
  <style>
    /* ã‚«ãƒ¼ãƒ‰é¸æŠå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .category-section {
      margin-bottom: 40px;
    }
    
    .category-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .category-header h2 {
      color: white;
      margin: 0 0 10px 0;
      font-size: 24px;
    }
    
    .category-description {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .category-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .card-item {
      background: white;
      border: 3px solid #e0e0e0;
      border-radius: 15px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .card-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }
    
    .card-item.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }
    
    .card-item.selected::after {
      content: "âœ“";
      position: absolute;
      top: 10px;
      right: 10px;
      background: #667eea;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }
    
    .card-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .card-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .card-description {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      text-align: center;
    }
    
    .progress-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-bar-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
    }
    
    .selection-summary {
      background: #f7f9fc;
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1 id="gameName">ã‚«ãƒ¼ãƒ‰é¸æŠ</h1>
      <div class="header-nav">
        <span class="status">ã‚¹ãƒ†ãƒƒãƒ— 1/4</span>
        <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 20px; font-size: 14px;">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="card">
      <div id="loadingMessage" class="loading">
        <div class="spinner"></div>
        <p>ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
      
      <div id="mainContent" style="display: none;">
        <!-- é€²æ—ãƒãƒ¼ -->
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
        </div>
        
        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="categoriesContainer"></div>
        
        <!-- é¸æŠã‚µãƒãƒªãƒ¼ -->
        <div class="selection-summary">
          <h3>é¸æŠçŠ¶æ³</h3>
          <div id="selectionSummary"></div>
        </div>
        
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons">
          <button onclick="resetSelection()" class="btn btn-secondary">
            ãƒªã‚»ãƒƒãƒˆ
          </button>
          <button id="nextButton" onclick="goToNext()" class="btn" disabled>
            æ¬¡ã¸é€²ã‚€
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ã‚³ã‚¢ã‚¯ãƒ©ã‚¹èª­ã¿è¾¼ã¿ -->
  <script src="/js/core/AuthManager.js"></script>
  <script src="/js/core/GameManager.js"></script>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    const authManager = new AuthManager();
    const gameManager = new GameManager();
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let gameData = null;
    let selectedCards = {};
    
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', async () => {
      // AuthManagerã§èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      if (!authManager.isAuthenticated()) {
        console.log('æœªèªè¨¼ã®ãŸã‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼å…¥åŠ›ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™');
        authManager.requireAuth('/card-selection.html');
        return;
      }
      
      console.log('èªè¨¼æ¸ˆã¿ - ã‚»ãƒƒã‚·ãƒ§ãƒ³æ®‹ã‚Šæ™‚é–“:', authManager.getRemainingTime(), 'åˆ†');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚²ãƒ¼ãƒ IDã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('id');
      
      if (!gameId) {
        console.error('ã‚²ãƒ¼ãƒ IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        alert('ã‚²ãƒ¼ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚²ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
        window.location.href = '/game-selection.html';
        return;
      }
      
      // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadGameData(gameId);
    });
    
    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadGameData(gameId) {
      try {
        // GameManagerã§ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        
        // ã¾ãšã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        await gameManager.loadGames();
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
        let currentGame = gameManager.restoreCurrentGame();
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãªã„ã€ã¾ãŸã¯ç•°ãªã‚‹ã‚²ãƒ¼ãƒ ã®å ´åˆã¯æ–°è¦é¸æŠ
        if (!currentGame || currentGame.id !== gameId) {
          currentGame = gameManager.selectGame(gameId);
        }
        
        gameData = gameManager.getGameData();
        
        if (!gameData) {
          throw new Error('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
        
        console.log('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', gameData);
        
        // ç”»é¢ã‚’åˆæœŸåŒ–
        initializeUI();
        renderCategories();
        updateSummary();
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
      } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' + error.message);
        window.location.href = '/game-selection.html';
      }
    }
    
    // UIåˆæœŸåŒ–
    function initializeUI() {
      document.getElementById('gameName').textContent = gameData.gameName;
      
      // é¸æŠçŠ¶æ…‹ã‚’åˆæœŸåŒ–
      gameData.cardCategories.forEach(category => {
        selectedCards[category.categoryId] = [];
      });
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
      const savedSelection = sessionStorage.getItem('selected_cards');
      if (savedSelection) {
        try {
          const savedCardsArray = JSON.parse(savedSelection);
          
          // é…åˆ—å½¢å¼ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¤‰æ›
          gameData.cardCategories.forEach(category => {
            selectedCards[category.categoryId] = [];
          });
          
          savedCardsArray.forEach(card => {
            if (selectedCards[card.categoryId]) {
              selectedCards[card.categoryId].push(card.cardId);
            }
          });
          
          console.log('é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', selectedCards);
        } catch (error) {
          console.warn('é¸æŠçŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
      }
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã¨ã‚«ãƒ¼ãƒ‰ã‚’æç”»
    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';
      
      // GameManagerã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
      const categories = gameManager.getCategories();
      
      categories.forEach(category => {
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        categorySection.id = `category-${category.categoryId}`;
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `
          <h2>${category.categoryName}</h2>
          <div class="category-description">${category.description}</div>
          <div class="category-info">
            é¸æŠæ•°: ${category.minSelect}ã€œ${category.maxSelect}æš
          </div>
        `;
        categorySection.appendChild(header);
        
        // ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰
        const cardsGrid = document.createElement('div');
        cardsGrid.className = 'cards-grid';
        
        // GameManagerã‹ã‚‰ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
        const categoryCards = gameManager.getCards(category.categoryId);
        
        categoryCards.forEach(card => {
          const cardElement = document.createElement('div');
          cardElement.className = 'card-item';
          cardElement.id = `card-${card.cardId}`;
          
          // ä¿å­˜ã•ã‚ŒãŸé¸æŠçŠ¶æ…‹ã‚’åæ˜ 
          if (selectedCards[category.categoryId]?.includes(card.cardId)) {
            cardElement.classList.add('selected');
          }
          
          cardElement.innerHTML = `
            <div class="card-icon">${card.icon || 'ğŸ“„'}</div>
            <div class="card-name">${card.cardName}</div>
            <div class="card-description">${card.description}</div>
          `;
          
          cardElement.addEventListener('click', () => toggleCard(category.categoryId, card.cardId));
          
          cardsGrid.appendChild(cardElement);
        });
        
        categorySection.appendChild(cardsGrid);
        container.appendChild(categorySection);
      });
    }
    
    // ã‚«ãƒ¼ãƒ‰é¸æŠ/è§£é™¤
    function toggleCard(categoryId, cardId) {
      const categories = gameManager.getCategories();
      const category = categories.find(c => c.categoryId === categoryId);
      const selected = selectedCards[categoryId];
      const cardIndex = selected.indexOf(cardId);
      
      if (cardIndex > -1) {
        // ã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ â†’ è§£é™¤
        selected.splice(cardIndex, 1);
        document.getElementById(`card-${cardId}`).classList.remove('selected');
      } else {
        // æœªé¸æŠ â†’ é¸æŠ
        if (selected.length >= category.maxSelect) {
          // æœ€å¤§é¸æŠæ•°ã‚’è¶…ãˆã‚‹å ´åˆã€æœ€åˆã®é¸æŠã‚’è§£é™¤
          const firstSelected = selected.shift();
          document.getElementById(`card-${firstSelected}`).classList.remove('selected');
        }
        selected.push(cardId);
        document.getElementById(`card-${cardId}`).classList.add('selected');
      }
      
      updateSummary();
      updateProgress();
      validateSelection();
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«å¤‰æ›ï¼‰
      const selectedCardsArray = [];
      Object.keys(selectedCards).forEach(categoryId => {
        selectedCards[categoryId].forEach(card => {
          selectedCardsArray.push(card);
        });
      });
      sessionStorage.setItem('selected_cards', JSON.stringify(selectedCardsArray));
    }
    
    // é¸æŠã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary() {
      const summaryContainer = document.getElementById('selectionSummary');
      summaryContainer.innerHTML = '';
      
      const categories = gameManager.getCategories();
      
      categories.forEach(category => {
        const selected = selectedCards[category.categoryId];
        const summaryItem = document.createElement('div');
        summaryItem.className = 'summary-item';
        
        const status = selected.length >= category.minSelect ? 'âœ“' : 'âš ï¸';
        const statusColor = selected.length >= category.minSelect ? '#10b981' : '#f59e0b';
        
        summaryItem.innerHTML = `
          <span style="font-weight: bold;">${category.categoryName}</span>
          <span style="color: ${statusColor};">
            ${status} ${selected.length}/${category.minSelect}ã€œ${category.maxSelect}æš
          </span>
        `;
        
        summaryContainer.appendChild(summaryItem);
      });
    }
    
    // é€²æ—ãƒãƒ¼æ›´æ–°
    function updateProgress() {
      const categories = gameManager.getCategories();
      let totalRequired = 0;
      let totalSelected = 0;
      
      categories.forEach(category => {
        totalRequired += category.minSelect;
        totalSelected += Math.min(selectedCards[category.categoryId].length, category.minSelect);
      });
      
      const progress = (totalSelected / totalRequired) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateSelection() {
      const categories = gameManager.getCategories();
      let valid = true;
      
      categories.forEach(category => {
        const selected = selectedCards[category.categoryId];
        if (selected.length < category.minSelect || selected.length > category.maxSelect) {
          valid = false;
        }
      });
      
      document.getElementById('nextButton').disabled = !valid;
    }
    
    // ãƒªã‚»ãƒƒãƒˆ
    function resetSelection() {
      if (confirm('é¸æŠã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        Object.keys(selectedCards).forEach(categoryId => {
          selectedCards[categoryId] = [];
        });
        
        document.querySelectorAll('.card-item.selected').forEach(card => {
          card.classList.remove('selected');
        });
        
        updateSummary();
        updateProgress();
        validateSelection();
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤
        sessionStorage.removeItem('selected_cards');
      }
    }
    
    // æ¬¡ã¸é€²ã‚€
    function goToNext() {
      // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«å¤‰æ›ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
      const selectedCardsArray = [];
      
      Object.keys(selectedCards).forEach(categoryId => {
        selectedCards[categoryId].forEach(card => {
          selectedCardsArray.push(card);
        });
      });
      
      sessionStorage.setItem('selected_cards', JSON.stringify(selectedCardsArray));
      
      console.log('ã‚«ãƒ¼ãƒ‰é¸æŠå®Œäº† - æ¬¡ã®ç”»é¢ã¸', selectedCardsArray);
      
      // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ç”»é¢ã¸
      window.location.href = '/input.html';
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        // AuthManagerã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        authManager.clearSession();
        
        // GameManagerã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        gameManager.reset();
        
        // é¸æŠçŠ¶æ…‹ã‚‚ã‚¯ãƒªã‚¢
        sessionStorage.removeItem('selected_cards');
        
        console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        window.location.href = '/access-key.html';
      }
    }
  </script>
</body>
</html>
