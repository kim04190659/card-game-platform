<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アクセスキー入力 - カードゲーム基盤システム</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <div class="container">
    <div class="card card-small">
      <h1>🔑 アクセスキー入力</h1>
      <p class="subtitle">
        このシステムはAI機能を使用します。<br>
        研修担当者から受け取ったアクセスキーを入力してください。
      </p>
      
      <form id="accessKeyForm">
        <div class="form-group">
          <input 
            type="text" 
            id="accessKey" 
            name="accessKey"
            placeholder="XXXX-XXXX-XXXX-XXXX"
            pattern="[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}"
            required
            autocomplete="off"
            style="text-align: center; font-family: monospace; letter-spacing: 2px; text-transform: uppercase;"
          >
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <button type="submit" class="btn" style="width: 100%;">
          開始
        </button>
      </form>
      
      <p style="margin-top: 30px; color: #999; font-size: 14px; text-align: center;">
        ※ アクセスキーがない場合は、研修担当者にお問い合わせください
      </p>
      
      <div style="margin-top: 20px; text-align: center;">
        <a href="/" style="color: #667eea; text-decoration: none;">← トップページに戻る</a>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('accessKeyForm');
      const accessKeyInput = document.getElementById('accessKey');
      const errorMessage = document.getElementById('errorMessage');
      
      // すでに認証済みの場合、ゲーム選択画面へ（後で実装）
      const sessionKey = sessionStorage.getItem('card_game_access_key');
      if (sessionKey) {
        // window.location.href = '/game-selection.html';
        // 今は何もしない
      }
      
      // 自動で大文字に変換 & ハイフン自動挿入
      accessKeyInput.addEventListener('input', (e) => {
        let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        
        // 4文字ごとにハイフンを挿入
        if (value.length > 4) {
          value = value.match(/.{1,4}/g).join('-');
        }
        
        e.target.value = value;
      });
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const accessKey = accessKeyInput.value.trim().toUpperCase();
        
        // バリデーション
        if (!accessKey.match(/^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/)) {
          showError('正しい形式で入力してください（例: ABCD-1234-EFGH-5678）');
          return;
        }
        
        // ローディング表示
        showLoading();
        
        try {
          // ⚠️ 今はダミー認証（後でAPI実装）
          await dummyAuthenticate(accessKey);
          
          // 成功: セッションに保存
          sessionStorage.setItem('card_game_access_key', accessKey);
          
          // ゲーム選択画面へ
          window.location.href = '/game-selection.html';
          
        } catch (error) {
          showError(error.message);
          hideLoading();
        }
      });
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
      }
      
      function showLoading() {
        const button = form.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = '認証中...';
        errorMessage.style.display = 'none';
      }
      
      function hideLoading() {
        const button = form.querySelector('button[type="submit"]');
        button.disabled = false;
        button.textContent = '開始';
      }
      
      // ⚠️ ダミー認証（テスト用）
      async function dummyAuthenticate(key) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            // テスト用キー: TEST-1234-ABCD-5678
            if (key === 'TEST-1234-ABCD-5678') {
              resolve({ valid: true });
            } else {
              reject(new Error('無効なアクセスキーです（テスト用キー: TEST-1234-ABCD-5678）'));
            }
          }, 1000);
        });
      }
    });
  </script>
</body>
</html>
