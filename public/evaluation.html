<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ë©ï‰æ°ÁµêÊûú - „Ç´„Éº„Éâ„Ç≤„Éº„É†Âü∫Áõ§„Ç∑„Çπ„ÉÜ„É†</title>
  <link rel="stylesheet" href="/css/common.css">
  <style>
    /* Ë©ï‰æ°ÁµêÊûúË°®Á§∫Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
    .evaluation-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .evaluation-header h1 {
      color: white;
      margin: 0 0 10px 0;
      font-size: 32px;
    }
    
    .evaluation-subtitle {
      opacity: 0.9;
      font-size: 16px;
    }
    
    .overall-score-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .overall-score-number {
      font-size: 72px;
      font-weight: bold;
      margin: 20px 0;
    }
    
    .score-excellent { color: #28a745; }
    .score-good { color: #ffc107; }
    .score-poor { color: #dc3545; }
    
    .overall-score-label {
      font-size: 24px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .overall-feedback {
      font-size: 18px;
      line-height: 1.6;
      color: #333;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }
    
    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .criteria-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .criteria-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .criteria-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .criteria-score {
      font-size: 24px;
      font-weight: bold;
    }
    
    .criteria-weight {
      font-size: 12px;
      color: #999;
      margin-left: 10px;
    }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.8s ease;
    }
    
    .criteria-reason {
      font-size: 14px;
      line-height: 1.5;
      color: #666;
    }
    
    .improvements-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .improvements-title {
      color: #667eea;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .improvement-item {
      background: #f8f9fa;
      border-left: 5px solid #667eea;
      padding: 15px 20px;
      margin-bottom: 15px;
      border-radius: 0 10px 10px 0;
    }
    
    .improvement-number {
      font-weight: bold;
      color: #667eea;
      margin-right: 10px;
    }
    
    .output-section {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 10px 0;
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 20px;
    }
    
    .collapsible-header h3 {
      color: #667eea;
      margin: 0;
      font-size: 20px;
    }
    
    .collapse-icon {
      font-size: 24px;
      color: #667eea;
      transition: transform 0.3s ease;
    }
    
    .collapse-icon.collapsed {
      transform: rotate(-90deg);
    }
    
    .output-content {
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 16px;
      color: #333;
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      min-width: 180px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-secondary:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .btn-download {
      background: #28a745;
      color: white;
    }
    
    .btn-download:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .criteria-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 300px;
      }
      
      .overall-score-number {
        font-size: 56px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3>Ë©ï‰æ°„ÇíÂÆüÊñΩ‰∏≠...</h3>
        <p>AI„ÅåÊàêÊûúÁâ©„ÇíË©≥Á¥∞„Å´Ë©ï‰æ°„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
      </div>
    </div>

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="evaluation-header">
      <h1>Ë©ï‰æ°ÁµêÊûú</h1>
      <div class="evaluation-subtitle" id="evaluationSubtitle">AI „Å´„Çà„ÇãÊàêÊûúÁâ©Ë©ï‰æ°</div>
    </div>

    <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- Á∑èÂêàË©ï‰æ°„Çπ„Ç≥„Ç¢ -->
    <div class="overall-score-card">
      <div class="overall-score-label">Á∑èÂêàË©ï‰æ°</div>
      <div id="overallScore" class="overall-score-number">-</div>
      <div id="overallFeedback" class="overall-feedback" style="display: none;"></div>
    </div>

    <!-- ÂêÑË©ï‰æ°Ëª∏ -->
    <div id="criteriaGrid" class="criteria-grid"></div>

    <!-- ÊîπÂñÑÊèêÊ°à -->
    <div class="improvements-section" style="display: none;" id="improvementsSection">
      <h3 class="improvements-title">üìà ÊîπÂñÑÊèêÊ°à</h3>
      <div id="improvementsList"></div>
    </div>

    <!-- ÊàêÊûúÁâ©Ë°®Á§∫ÔºàÊäò„Çä„Åü„Åü„ÅøÔºâ -->
    <div class="output-section" style="display: none;" id="outputSection">
      <div class="collapsible-header" onclick="toggleOutput()">
        <h3>üìÑ ÁîüÊàê„Åï„Çå„ÅüÊàêÊûúÁâ©</h3>
        <span id="collapseIcon" class="collapse-icon">‚ñº</span>
      </div>
      <div id="outputContent" class="output-content"></div>
    </div>

    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
    <div class="action-buttons">
      <button onclick="retryChallenge()" class="btn btn-primary">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>
      <button onclick="goToGameSelection()" class="btn btn-secondary">ÊúÄÂàù„Å´Êàª„Çã</button>
      <button id="downloadBtn" onclick="downloadReport()" class="btn btn-download" disabled>Ë©ï‰æ°„É¨„Éù„Éº„Éà„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
    </div>
  </div>

  <script src="/js/core/AuthManager.js"></script>
  <script src="/js/core/GameManager.js"></script>
  <script src="/js/core/Evaluator.js"></script>
  <script>
    class EvaluationPage {
      constructor() {
        this.authManager = new AuthManager();
        this.gameManager = new GameManager();
        this.evaluator = null;
        this.evaluation = null;
        this.outputCollapsed = false;
      }

      async init() {
        try {
          // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
          if (!this.authManager.isAuthenticated()) {
            alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            window.location.href = '/access-key.html';
            return;
          }

          // ÂøÖË¶Å„Å™„Éá„Éº„ÇøÂèñÂæó
          const generatedOutput = sessionStorage.getItem('generatedOutput');
          
          if (!generatedOutput) {
            throw new Error('ÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
          }

          // „Ç≤„Éº„É†„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
          const gameInfo = this.gameManager.restoreCurrentGame();
          if (!gameInfo) {
            throw new Error('„Ç≤„Éº„É†„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
          }
          
          const game = gameInfo.data; // ÂÆüÈöõ„ÅÆ„Ç≤„Éº„É†Ë®≠ÂÆö„Éá„Éº„Çø

          const selectedCards = JSON.parse(sessionStorage.getItem('selected_cards') || '[]');
          const userInputs = JSON.parse(sessionStorage.getItem('user_inputs') || '{}');

          // EvaluatorÂàùÊúüÂåñ
          this.evaluator = new Evaluator(game, generatedOutput, selectedCards, userInputs);

          // UIÂàùÊúüÂåñ
          this.initUI(game, generatedOutput);

          // Ë©ï‰æ°ÂÆüÊñΩ
          await this.performEvaluation();

        } catch (error) {
          console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
          this.showError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        }
      }

      initUI(game, output) {
        // „Çµ„Éñ„Çø„Ç§„Éà„É´Êõ¥Êñ∞
        document.getElementById('evaluationSubtitle').textContent = `${game.gameName} - ${game.outputType}`;
        
        // ÊàêÊûúÁâ©Ë°®Á§∫
        document.getElementById('outputContent').textContent = output;
        document.getElementById('outputSection').style.display = 'block';
      }

      async performEvaluation() {
        try {
          this.showLoading(true);
          
          this.evaluation = await this.evaluator.evaluate();
          
          // UIÊõ¥Êñ∞
          this.displayEvaluation();
          
          // „Çª„ÉÉ„Ç∑„Éß„É≥‰øùÂ≠ò
          sessionStorage.setItem('evaluation', JSON.stringify(this.evaluation));
          
          // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥ÊúâÂäπÂåñ
          document.getElementById('downloadBtn').disabled = false;

        } catch (error) {
          console.error('Ë©ï‰æ°„Ç®„É©„Éº:', error);
          this.showError('Ë©ï‰æ°„ÅÆÂÆüÊñΩ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      }

      displayEvaluation() {
        // Á∑èÂêà„Çπ„Ç≥„Ç¢Ë°®Á§∫
        this.displayOverallScore();
        
        // ÂêÑË©ï‰æ°Ëª∏Ë°®Á§∫
        this.displayCriteria();
        
        // ÊîπÂñÑÊèêÊ°àË°®Á§∫
        this.displayImprovements();
      }

      displayOverallScore() {
        const scoreElement = document.getElementById('overallScore');
        const feedbackElement = document.getElementById('overallFeedback');
        
        const score = this.evaluation.overallScore;
        scoreElement.textContent = score + 'ÁÇπ';
        
        // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶Ëâ≤ÂàÜ„Åë
        scoreElement.className = 'overall-score-number';
        if (score >= 80) {
          scoreElement.classList.add('score-excellent');
        } else if (score >= 60) {
          scoreElement.classList.add('score-good');
        } else {
          scoreElement.classList.add('score-poor');
        }
        
        // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
        if (this.evaluation.feedback) {
          feedbackElement.textContent = this.evaluation.feedback;
          feedbackElement.style.display = 'block';
        }
      }

      displayCriteria() {
        const container = document.getElementById('criteriaGrid');
        const game = this.gameManager.getCurrentGame().data;
        
        let html = '';
        
        game.evaluationCriteria.forEach(criteria => {
          const score = this.evaluation.scores[criteria.criteriaId] || 0;
          const reason = this.evaluation.reasons[criteria.criteriaId] || '';
          const weight = Math.round(criteria.weight * 100);
          
          let scoreClass = 'score-poor';
          let progressColor = '#dc3545';
          
          if (score >= 80) {
            scoreClass = 'score-excellent';
            progressColor = '#28a745';
          } else if (score >= 60) {
            scoreClass = 'score-good';
            progressColor = '#ffc107';
          }
          
          html += `
            <div class="criteria-card">
              <div class="criteria-header">
                <div>
                  <div class="criteria-name">${criteria.criteriaName}</div>
                  <span class="criteria-weight">Èáç„Åø: ${weight}%</span>
                </div>
                <div class="criteria-score ${scoreClass}">${score}ÁÇπ</div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${score}%; background-color: ${progressColor};"></div>
              </div>
              <div class="criteria-reason">${reason}</div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      }

      displayImprovements() {
        if (!this.evaluation.improvements || this.evaluation.improvements.length === 0) {
          return;
        }
        
        const container = document.getElementById('improvementsList');
        let html = '';
        
        this.evaluation.improvements.forEach((improvement, index) => {
          html += `
            <div class="improvement-item">
              <span class="improvement-number">${index + 1}.</span>
              ${improvement}
            </div>
          `;
        });
        
        container.innerHTML = html;
        document.getElementById('improvementsSection').style.display = 'block';
      }

      showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      }

      showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }

    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
    function toggleOutput() {
      const content = document.getElementById('outputContent');
      const icon = document.getElementById('collapseIcon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
        icon.classList.remove('collapsed');
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
        icon.classList.add('collapsed');
      }
    }

    function retryChallenge() {
      if (confirm('„Ç´„Éº„ÉâÈÅ∏Êäû„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü')) {
        // ÊàêÊûúÁâ©„Å®Ë©ï‰æ°ÁµêÊûú„Çí„ÇØ„É™„Ç¢
        sessionStorage.removeItem('generatedOutput');
        sessionStorage.removeItem('evaluation');
        window.location.href = '/card-selection.html';
      }
    }

    function goToGameSelection() {
      if (confirm('ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºüÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åô„ÄÇ')) {
        // ÂÖ®„Éá„Éº„Çø„ÇØ„É™„Ç¢
        sessionStorage.removeItem('selectedGameId');
        sessionStorage.removeItem('selectedCards');
        sessionStorage.removeItem('userInputs');
        sessionStorage.removeItem('generatedOutput');
        sessionStorage.removeItem('evaluation');
        window.location.href = '/game-selection.html';
      }
    }

    function downloadReport() {
      try {
        const gameData = JSON.parse(sessionStorage.getItem('currentGameData'));
        const game = gameData.data;
        const output = sessionStorage.getItem('generatedOutput');
        const evaluation = JSON.parse(sessionStorage.getItem('evaluation'));
        
        let report = `=== ${game.outputType} Ë©ï‰æ°„É¨„Éù„Éº„Éà ===\n\n`;
        report += `„Ç≤„Éº„É†: ${game.gameName}\n`;
        report += `ÁîüÊàêÊó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}\n\n`;
        
        report += `=== Á∑èÂêàË©ï‰æ° ===\n`;
        report += `Á∑èÂêà„Çπ„Ç≥„Ç¢: ${evaluation.overallScore}ÁÇπ\n`;
        if (evaluation.feedback) {
          report += `Á∑èÂêà„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ: ${evaluation.feedback}\n`;
        }
        report += `\n`;
        
        report += `=== Ë©≥Á¥∞Ë©ï‰æ° ===\n`;
        game.evaluationCriteria.forEach(criteria => {
          const score = evaluation.scores[criteria.criteriaId];
          const reason = evaluation.reasons[criteria.criteriaId];
          const weight = Math.round(criteria.weight * 100);
          
          report += `${criteria.criteriaName} (Èáç„Åø: ${weight}%): ${score}ÁÇπ\n`;
          report += `ÁêÜÁî±: ${reason}\n\n`;
        });
        
        report += `=== ÊîπÂñÑÊèêÊ°à ===\n`;
        evaluation.improvements.forEach((improvement, index) => {
          report += `${index + 1}. ${improvement}\n`;
        });
        report += `\n`;
        
        report += `=== ÁîüÊàê„Åï„Çå„ÅüÊàêÊûúÁâ© ===\n`;
        report += output;
        
        const filename = `Ë©ï‰æ°„É¨„Éù„Éº„Éà_${game.outputType}_${new Date().toISOString().slice(0, 10)}.txt`;
        const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('„É¨„Éù„Éº„ÉàÁîüÊàê„Ç®„É©„Éº:', error);
        alert('„É¨„Éù„Éº„Éà„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }

    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', () => {
      const evaluationPage = new EvaluationPage();
      evaluationPage.init();
    });
  </script>
</body>
</html>